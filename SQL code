#pro-talon-355008.GAsample.ga_actiontype
SELECT
    PARSE_DATE('%Y%m%d', date) AS date,
    CONCAT(fullVisitorId, CAST(visitId AS STRING)) AS unique_session_id,
    geoNetwork.country AS country,
    device.deviceCategory AS device_category,
    trafficSource.medium,
    IFNULL(totals.bounces, 0) AS bounce,
    CAST(hits.eCommerceAction.action_type AS INT64) AS action,
    CASE hits.eCommerceAction.action_type
      WHEN '0' THEN 'Visit'
      WHEN '1' THEN 'Product List'
      WHEN '2' THEN 'Product Detail Pages'
      WHEN '3' THEN 'Add to Cart'
      WHEN '4' THEN 'Remove from Cart'
      WHEN '5' THEN 'Checkout'
      WHEN '6' THEN 'Order Complete'
      WHEN '7' THEN 'Product Refund'
      WHEN '8' THEN 'Checkout Options'
    END AS action_type,
    productsku as product_sku,
  -- cart-to-detail rate (metric)
  case when count(case when hits.ecommerceaction.action_type = '2' then fullvisitorid else null end) = 0 then 0 else count(case when hits.ecommerceaction.action_type = '3' 
  then fullvisitorid else null end) / count(case when hits.ecommerceaction.action_type = '2' then fullvisitorid else null end) end as cart_to_detail_rate,
  -- buy-to-detail rate (metric)
  case when count(case when hits.ecommerceaction.action_type = '2' then fullvisitorid else null end) = 0 then 0 else count(case when hits.ecommerceaction.action_type = '6' 
  then hits.transaction.transactionid else null end) / count(case when hits.ecommerceaction.action_type = '2' then fullvisitorid else null end) end as buy_to_detail_rate
  
  FROM
    `bigquery-public-data.google_analytics_sample.ga_sessions_*`,
    UNNEST(hits) AS hits,
    UNNEST(product) AS product
  
  WHERE
    _TABLE_SUFFIX BETWEEN '20160801' AND '20170731'

GROUP BY
1,2,3,4,5,6,7,8,9





